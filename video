#!/bin/bash

# Script centralizador para a infraestrutura do Video Core
# Uso: ./video [comando] [opções]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$SCRIPT_DIR/scripts"

# Função para exibir ajuda
show_help() {
  echo "Video Core (Infra) - CLI de gerenciamento da infraestrutura"
  echo
  echo "Uso: ./video [comando] [opções]"
  echo
  echo "Comandos disponíveis:"
  echo "  start:infra      Inicia apenas a infraestrutura (banco)"
  echo "  stop:infra       Para apenas a infraestrutura"
  echo "  restart:all      Reinicia todos os serviços da infraestrutura"
  echo "  az:pub           Publica um vídeo no Azurite e emite um evento no Azure Service Bus"
  echo "  init:user        Inicializa usuário no LocalStack Cognito"
  echo "  help             Exibe esta mensagem de ajuda"
  echo
  echo "Opções:"
  echo "  --force, -f      Força a execução sem confirmação"
  echo
  echo "Exemplos:"
  echo "  ./video start:infra        Inicia a infraestrutura"
  echo "  ./video stop:infra         Para a infraestrutura"
  echo "  ./video restart:all        Reinicia a infraestrutura"
  echo "  ./video az:pub             Publica um vídeo no Azurite e emite um evento no Azure Service Bus"
  echo "  ./video az:view            Lista os arquivos do container images no Azurite"
  echo "  ./video az:download        Baixa o arquivo mais recente do container images no Azurite"
  echo "  ./video az:delete-all      Deleta todos os blobs do container images no Azurite"
  echo "  ./video init:user          Inicializa usuário no LocalStack Cognito"
  echo "  ./video help               Exibe a ajuda"
}

# Verificar se o Docker está rodando
check_docker() {
  docker info &>/dev/null
  return $?
}

if ! check_docker; then
  echo "ERRO: O Docker não está rodando."
  echo "Por favor, inicie o Docker Desktop e tente novamente."
  exit 1
fi

# Verificar se o comando foi fornecido
if [ $# -eq 0 ]; then
  show_help
  exit 1
fi

# Processar opções
FORCE_FLAG=""
while [[ $# -gt 0 ]]; do
  case $1 in
    --force|-f)
      FORCE_FLAG="--force"
      shift
      ;;
    *)
      COMMAND="$1"
      shift
      ;;
  esac
done

# Executar o comando apropriado
case "$COMMAND" in
  start:infra)
    echo "Iniciando a infraestrutura..."
    "$SCRIPTS_DIR/infra-up.sh" $FORCE_FLAG
    # Verificar se a rede videocore-network existe, se não, criar
    if ! docker network ls | grep -q videocore-network; then
      echo "Criando rede compartilhada videocore-network..."
      docker network create videocore-network
    fi
    ;;
  stop:infra)
    echo "Parando a infraestrutura..."
    "$SCRIPTS_DIR/infra-down.sh"
    ;;
  restart:all)
    echo "Reiniciando a infraestrutura..."
    "$SCRIPTS_DIR/infra-restart.sh" $FORCE_FLAG
    ;;
  az:pub)
    echo "Publicando vídeo no Azurite e emitindo evento no Azure Service Bus..."
    "$SCRIPTS_DIR/az-integration.sh"
    ;;
  az:view)
    echo "Listando arquivos do container images..."
    echo
    "$SCRIPTS_DIR/az-view-files.sh"
    ;;
  az:download)
    echo "Baixando o arquivo mais recente do container images..."
    echo
    "$SCRIPTS_DIR/az-download-file.sh"
    ;;
  az:delete-all)
    echo "Deletando todos os blobs do container images..."
    echo
    "$SCRIPTS_DIR/az-delete-all.sh"
    ;;
  init:user)
    echo "Inicializando usuário no LocalStack Cognito..."
    "$SCRIPTS_DIR/init-user.sh"
    ;;
  help)
    show_help
    ;;
  *)
    echo "ERRO: Comando desconhecido: $COMMAND"
    echo "Use './video help' para ver os comandos disponíveis."
    exit 1
    ;;
esac